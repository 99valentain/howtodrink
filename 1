<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 ì—°êµ¬ë…¸íŠ¸ í¬íŠ¸í´ë¦¬ì˜¤: Researcher Haneulssi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Plotly.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Font: Pretendard & Noto Sans KR -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Day Theme (Sakura - Default) */
            --bg-color: #FFF1F2;
            --text-color: #4A044E;
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(251, 113, 133, 0.2);
            --accent-primary: #db2777;
            --accent-secondary: #f472b6;
            --particle-color: 251, 113, 133;
        }

        [data-theme="dark"] {
            /* Night Theme */
            --bg-color: #0F172A;
            --text-color: #F1F5F9;
            --card-bg: rgba(30, 41, 59, 0.6);
            --card-border: rgba(255, 255, 255, 0.05);
            --accent-primary: #6366f1;
            --accent-secondary: #38bdf8;
            --particle-color: 255, 255, 255;
        }

        body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: background-color 0.8s ease, color 0.5s ease;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Logic */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            transition: transform 0.3s ease, background 0.5s ease, border-color 0.5s ease, box-shadow 0.3s ease;
        }
        
        .glass-header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: all 0.5s ease;
        }

        /* Particle Canvas */
        #particle-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        
        /* Chat Bubble Animation */
        .chat-bubble {
            animation: fadeInUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0; transform: translateY(10px);
        }
        
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .suggestion-chip {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .suggestion-chip:active {
            transform: scale(0.92);
        }
        
        /* Music Player */
        .music-player {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            transition: all 0.3s ease;
        }
        .music-disc {
            animation: spin 4s linear infinite;
            animation-play-state: paused;
        }
        .playing .music-disc { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Floating Animation */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: rgba(150, 150, 150, 0.3);
            border-radius: 2px;
        }
    </style>
</head>
<body class="antialiased pb-28 relative" data-theme="light">

    <canvas id="particle-canvas"></canvas>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 glass-header">
        <div class="max-w-3xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-500/10 p-2 rounded-xl border border-indigo-500/20 shadow-sm">
                        <i class="ph-fill ph-student text-2xl" style="color: var(--accent-primary)"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-none tracking-tight">Haneulssi's Lab</h1>
                        <p class="text-[10px] opacity-70 mt-1 font-medium tracking-wide uppercase">Nutritional Epidemiology</p>
                    </div>
                </div>
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2.5 rounded-full bg-slate-500/10 hover:bg-slate-500/20 transition active:rotate-180 duration-500">
                    <i id="theme-icon" class="ph-fill ph-flower-lotus text-xl text-pink-500"></i>
                </button>
            </div>
            <!-- Tabs -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar mt-3 pb-1 px-1">
                <a href="#abstract" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-indigo-500/10 text-[var(--accent-primary)] border border-indigo-500/20 hover:bg-indigo-500/20 transition">ì—°êµ¬ ê°œìš”</a>
                <a href="#results" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">ë¶„ì„ ê²°ê³¼</a>
                <a href="#dose-response" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">ë°˜ì‘í˜• ëª¨ë¸</a>
                <a href="#simulator" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">ì‹œë®¬ë ˆì´í„°</a>
                <a href="#chat" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">AI ë¦¬í¬íŠ¸</a>
            </div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto px-4 py-6 space-y-10 relative z-10">

        <!-- 1. Abstract -->
        <section id="abstract" class="space-y-4 animate__animated animate__fadeIn">
            <div class="glass-panel p-6 relative overflow-hidden group">
                <div class="absolute -top-12 -right-12 w-48 h-48 bg-gradient-to-br from-[var(--accent-primary)] to-[var(--accent-secondary)] rounded-full blur-[70px] opacity-20 group-hover:opacity-30 transition duration-700 animate-float"></div>
                
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="px-2.5 py-1 rounded-md text-[10px] font-bold bg-sky-500/10 text-sky-500 border border-sky-500/20 backdrop-blur-sm">2026 KNHANES PROJECT</span>
                    </div>
                    <h2 class="text-2xl font-extrabold mb-4 leading-snug">
                        Association between <span class="gradient-text">Beverage Consumption</span><br>
                        and Kidney Function
                    </h2>
                    <p class="text-sm opacity-80 leading-relaxed mb-5 font-light">
                        í•œêµ­ ì„±ì¸ì˜ ìŒë£Œ ì„­ì·¨ íŒ¨í„´ì´ ì‹ ì¥ ê¸°ëŠ¥(eGFR)ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ë¶„ì„í•˜ê³ , ë‹¹ë‡¨ë³‘ í™˜ìêµ°ì„ ìœ„í•œ ë§ì¶¤í˜• ê°€ì´ë“œë¥¼ ì œì•ˆí•©ë‹ˆë‹¤.
                    </p>
                    <div class="grid grid-cols-2 gap-3 pt-4 border-t border-dashed border-gray-500/20">
                        <div class="hover:bg-white/5 p-2 rounded-lg transition">
                            <h3 style="color: var(--accent-secondary)" class="font-bold mb-1 text-xs tracking-wider">OBJECTIVE</h3>
                            <p class="text-[11px] opacity-70">ë¯¹ìŠ¤ì»¤í”¼ vs ë¸”ë™ì»¤í”¼<br>ì°¨ë³„ì  ì˜í–¥ ê·œëª…</p>
                        </div>
                        <div class="hover:bg-white/5 p-2 rounded-lg transition">
                            <h3 style="color: var(--accent-secondary)" class="font-bold mb-1 text-xs tracking-wider">DATA SOURCE</h3>
                            <p class="text-[11px] opacity-70">KNHANES ì œ9ê¸°<br>(2022-2024)</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Results: Evidence Galaxy (Plotly) -->
        <section id="results" class="space-y-4">
            <div class="flex items-center gap-2 px-1 mb-2">
                <i class="ph-fill ph-planet text-amber-500 text-lg"></i>
                <h3 class="text-base font-bold">ì¦ê±°ì˜ ì€í•˜ê³„ (Evidence Galaxy)</h3>
            </div>
            <div class="glass-panel p-4 relative overflow-hidden">
                <p class="text-[11px] opacity-60 mb-2 px-1">ì´ 12í¸ì˜ í•µì‹¬ ë…¼ë¬¸ ë¶„í¬ (ì› í¬ê¸° = í‘œë³¸ ìˆ˜)</p>
                <!-- Plotly Chart Container -->
                <div id="bubbleChart" class="w-full h-[400px]"></div>
                <!-- Interactive Detail Panel -->
                <div id="study-detail-panel" class="hidden mt-3 bg-white/50 border-l-4 border-amber-500 p-3 rounded-r-lg backdrop-blur-sm transition-all text-xs">
                    <h4 id="detail-title" class="font-bold mb-1">ë…¼ë¬¸ ì œëª©</h4>
                    <p id="detail-desc" class="opacity-80 leading-snug">ì„¤ëª…...</p>
                </div>
            </div>
        </section>

        <!-- 3. Dose-Response Model (Interactive) -->
        <section id="dose-response" class="space-y-4">
            <div class="flex items-center gap-2 px-1 mb-2">
                <i class="ph-fill ph-faders text-emerald-500 text-lg"></i>
                <h3 class="text-base font-bold">ìš©ëŸ‰-ë°˜ì‘ ëª¨ë¸ (Dose-Response)</h3>
            </div>
            
            <div class="glass-panel p-6">
                <div class="mb-6">
                    <h4 class="text-sm font-bold opacity-90 mb-1">í•˜ë£¨ ì»¤í”¼ ì„­ì·¨ëŸ‰ ì‹œë®¬ë ˆì´ì…˜</h4>
                    <p class="text-[11px] opacity-60">ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ CKD ìœ„í—˜ë„ ë³€í™”ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                </div>

                <!-- Slider Control -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-3xl font-bold" style="color: var(--accent-primary)" id="cup-display">0</span>
                        <span class="text-xs font-bold opacity-50 uppercase tracking-widest">Cups / Day</span>
                    </div>
                    <input type="range" min="0" max="6" value="0" step="1" id="cup-slider" class="w-full">
                    <div class="flex justify-between text-[10px] opacity-40 mt-2 font-mono">
                        <span>0</span><span>2</span><span>4</span><span>6+</span>
                    </div>
                    <!-- Insight Box -->
                    <div id="insight-box" class="mt-4 p-3 bg-indigo-500/5 rounded-xl border border-indigo-500/10 text-xs opacity-80 leading-relaxed font-medium transition-all">
                        ê¸°ì¤€ì ì…ë‹ˆë‹¤. ì»¤í”¼ í´ë¦¬í˜ë†€ì˜ ì´ì ì´ ì•„ì§ ì ìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                    </div>
                </div>

                <!-- Line Chart -->
                <div class="h-[250px] w-full bg-white/30 rounded-xl p-2">
                    <canvas id="doseChart"></canvas>
                </div>
                <p class="text-[9px] opacity-40 mt-2 text-right">*Based on Meta-analysis (Gao et al., 2025)</p>
            </div>
        </section>

        <!-- 4. Simulator (Tamagotchi) -->
        <section id="simulator" class="glass-panel p-6 relative overflow-hidden">
            <div class="flex items-center justify-between mb-8 relative z-10">
                <div>
                    <h2 class="text-base font-bold flex items-center gap-2">
                        <i class="ph-fill ph-flask" style="color: var(--accent-primary)"></i> ì‹ ì¥ ë‹¤ë§ˆê³ ì¹˜
                    </h2>
                    <p class="opacity-60 text-[10px] mt-1 ml-6">ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§</p>
                </div>
                <button onclick="window.resetDrinks()" class="text-[10px] font-bold bg-slate-500/10 hover:bg-slate-500/20 px-3 py-1.5 rounded-lg transition flex items-center gap-1 active:scale-95">
                    <i class="ph-bold ph-arrow-counter-clockwise"></i> ì´ˆê¸°í™”
                </button>
            </div>

            <div class="flex flex-col items-center gap-8 relative z-10">
                <!-- Character & Bar -->
                <div class="flex flex-col items-center justify-center w-full relative">
                    <div class="relative mb-6 group">
                        <div class="absolute inset-0 bg-emerald-500/20 rounded-full blur-2xl opacity-0 group-hover:opacity-50 transition duration-500"></div>
                        <div id="kidney-char" class="text-[90px] transition-all duration-300 drop-shadow-2xl cursor-pointer select-none hover:scale-110 active:scale-90 relative z-10" onclick="window.pokeKidney()">ğŸ«˜</div>
                        <div id="status-badge" class="absolute -top-2 -right-8 bg-emerald-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg animate-bounce border border-white/20">
                            ìµœì ìƒíƒœ
                        </div>
                    </div>
                    
                    <div class="w-full space-y-2.5">
                        <div class="flex justify-between text-xs font-bold opacity-80 px-1">
                            <span>ê±´ê°• ì ìˆ˜</span>
                            <span id="score-val" class="text-emerald-500">100ì </span>
                        </div>
                        <div class="w-full bg-slate-500/10 rounded-full h-3.5 overflow-hidden ring-1 ring-slate-500/5">
                            <div id="health-bar" class="bg-gradient-to-r from-emerald-500 to-teal-400 h-full w-full transition-all duration-700 relative shadow-[0_0_10px_rgba(16,185,129,0.3)]">
                                <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                            </div>
                        </div>
                        <p id="status-desc" class="text-center text-[11px] opacity-70 mt-1 font-medium">í•­ì‚°í™” íš¨ê³¼ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="w-full grid grid-cols-2 gap-3">
                    <!-- Tea -->
                    <div class="relative group">
                        <button onclick="window.addDrink('tea')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-emerald-500/5 transition active:scale-[0.97] border-emerald-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">ğŸµ</span>
                            <div class="text-[11px] font-bold mt-1">ë…¹ì°¨/í™ì°¨</div>
                            <div class="text-[9px] text-emerald-500 font-medium">+3ì </div>
                            <div id="count-tea" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('tea', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>

                    <!-- Black Coffee -->
                    <div class="relative group">
                        <button onclick="window.addDrink('black')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-indigo-500/5 transition active:scale-[0.97] border-indigo-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">â˜•</span>
                            <div class="text-[11px] font-bold mt-1">ë¸”ë™ì»¤í”¼</div>
                            <div class="text-[9px] text-indigo-500 font-medium">+2ì </div>
                            <div id="count-black" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('black', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>

                    <!-- Mix Coffee -->
                    <div class="relative group">
                        <button onclick="window.addDrink('mix')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-amber-500/5 transition active:scale-[0.97] border-amber-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">ğŸ¬</span>
                            <div class="text-[11px] font-bold mt-1">ë¯¹ìŠ¤ì»¤í”¼</div>
                            <div class="text-[9px] text-amber-500 font-medium">-5ì </div>
                            <div id="count-mix" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('mix', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>

                    <!-- SSB -->
                    <div class="relative group">
                        <button onclick="window.addDrink('ssb')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-rose-500/5 transition active:scale-[0.97] border-rose-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">ğŸ¥¤</span>
                            <div class="text-[11px] font-bold mt-1">íƒ„ì‚°/ì£¼ìŠ¤</div>
                            <div class="text-[9px] text-rose-500 font-medium">-10ì </div>
                            <div id="count-ssb" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('ssb', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. AI Assistant -->
        <section id="chat" class="glass-panel flex flex-col h-[520px] overflow-hidden shadow-xl">
            <div class="p-4 border-b border-gray-500/10 flex justify-between items-center bg-gray-500/5 backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-2.5 h-2.5 bg-emerald-500 rounded-full absolute -right-0.5 -bottom-0.5 border-2 border-white animate-pulse"></div>
                        <span class="text-2xl">ğŸ‘©â€ğŸ’»</span>
                    </div>
                    <div>
                        <span class="font-bold text-sm block">Researcher haneulssi</span>
                        <span class="text-[10px] opacity-70 block font-bold tracking-wide">AI Assistant</span>
                    </div>
                </div>
            </div>
            
            <div id="chat-window" class="flex-1 p-5 overflow-y-auto space-y-5 bg-transparent scroll-smooth">
                <div class="flex gap-3 animate__animated animate__fadeIn">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500/10 flex items-center justify-center text-sm border border-indigo-500/20">ğŸ‘©â€ğŸ’»</div>
                    <div class="glass-panel p-3.5 rounded-tl-none text-xs opacity-90 leading-relaxed max-w-[88%] shadow-sm">
                        ì•ˆë…•í•˜ì„¸ìš”! <strong>Researcher haneulssi</strong>ì…ë‹ˆë‹¤.<br><br>
                        2025ë…„ 9ì›”ë¶€í„° 2026ë…„ 1ì›”ê¹Œì§€ì˜ ì—°êµ¬ë…¸íŠ¸ì™€ ì„ í–‰ ë…¼ë¬¸ì„ ì™„ë²½í•˜ê²Œ í•™ìŠµí–ˆìŠµë‹ˆë‹¤.<br>
                        ì•„ë˜ í‚¤ì›Œë“œë¥¼ ëˆŒëŸ¬ë³´ì„¸ìš”. ë…¼ë¬¸ì„ ê¸°ë°˜ìœ¼ë¡œ ì¦‰ì‹œ ë‹µë³€í•´ ë“œë¦´ê²Œìš”! ğŸ“š
                    </div>
                </div>
            </div>
            
            <!-- Quick Chips -->
            <div class="p-4 border-t border-gray-500/10 bg-gray-500/5 backdrop-blur-md">
                <p class="text-[10px] opacity-50 mb-3 font-bold ml-1 uppercase tracking-wider">Tap to ask:</p>
                <div class="flex flex-col gap-2.5">
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                        <button onclick="askAI('method')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-indigo-500/10 hover:bg-indigo-500/20 text-[11px] font-bold rounded-xl border border-indigo-500/20 text-indigo-500">ğŸ”¬ ì—°êµ¬ ë°©ë²•</button>
                        <button onclick="askAI('coffee_diff')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-amber-500/10 hover:bg-amber-500/20 text-[11px] font-bold rounded-xl border border-amber-500/20 text-amber-500">â˜• ë¯¹ìŠ¤ vs ë¸”ë™</button>
                        <button onclick="askAI('tea_timing')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-[11px] font-bold rounded-xl border border-emerald-500/20 text-emerald-500">â° ì°¨ ì„­ì·¨ íƒ€ì´ë°</button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                        <button onclick="askAI('mechanism')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-purple-500/10 hover:bg-purple-500/20 text-[11px] font-bold rounded-xl border border-purple-500/20 text-purple-500">ğŸ§¬ ì‘ìš© ê¸°ì „</button>
                        <button onclick="askAI('diabetes')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-rose-500/10 hover:bg-rose-500/20 text-[11px] font-bold rounded-xl border border-rose-500/20 text-rose-500">ğŸ©¸ ë‹¹ë‡¨ í™˜ì ìœ„í—˜ì„±</button>
                        <button onclick="askAI('gender')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-blue-500/10 hover:bg-blue-500/20 text-[11px] font-bold rounded-xl border border-blue-500/20 text-blue-500">ğŸ‘« ì„±ë³„ ì°¨ì´</button>
                        <button onclick="askAI('conclusion')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-slate-500/10 hover:bg-slate-500/20 text-[11px] font-bold rounded-xl border border-slate-500/20 opacity-70">ğŸ“‘ ê²°ë¡  ìš”ì•½</button>
                        <button onclick="askAI('limitation')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-slate-500/10 hover:bg-slate-500/20 text-[11px] font-bold rounded-xl border border-slate-500/20 opacity-70">ğŸš§ ì—°êµ¬ì˜ í•œê³„</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <section class="text-center pt-8 pb-4">
            <p class="opacity-50 text-[10px] font-medium tracking-widest uppercase">Â© 2026 Researcher Haneulssi</p>
            <div class="inline-flex items-center gap-2 mt-3 px-3 py-1 bg-gray-500/10 rounded-full text-[10px] opacity-60 backdrop-blur-sm">
                <i class="ph-fill ph-eye"></i>
                <span id="visit-count" class="font-mono font-bold">1,240</span>
            </div>
        </section>

    </main>

    <!-- Music Player Widget -->
    <div class="music-player glass-panel p-2 flex items-center gap-3 pr-4 rounded-full border border-white/20 shadow-xl backdrop-blur-xl">
        <div class="music-disc w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center border-2 border-slate-600 relative overflow-hidden" id="disc-icon">
            <div class="w-2 h-2 bg-white rounded-full z-10"></div>
            <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent"></div>
        </div>
        <div class="flex flex-col">
            <span class="text-[10px] font-bold opacity-80" id="music-title">Music Off</span>
            <span class="text-[8px] opacity-50" id="music-genre">Select Genre</span>
        </div>
        <div class="flex gap-2 ml-2">
            <button onclick="playMusic('spring')" class="text-lg hover:scale-110 transition active:scale-95" title="Vivaldi - Spring">ğŸ»</button>
            <button onclick="playMusic('mozart')" class="text-lg hover:scale-110 transition active:scale-95" title="Mozart - Nachtmusik">ğŸ¹</button>
            <button onclick="stopMusic()" class="text-lg hover:scale-110 transition active:scale-95 text-rose-400" title="Stop">â¹ï¸</button>
        </div>
        <audio id="bgm-player" loop></audio>
    </div>

    <script>
        // --- Theme Logic (Sakura Morning Default) ---
        let isDarkMode = false; // Start in Day Mode
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');
        const particleCanvas = document.getElementById('particle-canvas');

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            
            if (isDarkMode) {
                // Night Mode
                themeIcon.className = 'ph-fill ph-moon-stars text-xl text-yellow-300';
                initParticles('stars');
            } else {
                // Day Mode (Sakura)
                themeIcon.className = 'ph-fill ph-flower-lotus text-xl text-pink-500';
                initParticles('sakura');
            }
            // Update charts color
            updateChartColors(isDarkMode);
            // Update Plotly
            initBubbleChart();
        }

        // --- Music Player Logic (Upbeat & Classy) ---
        const audio = document.getElementById('bgm-player');
        const disc = document.getElementById('disc-icon');
        const musicTitle = document.getElementById('music-title');
        const musicGenre = document.getElementById('music-genre');
        const musicPlayerDiv = document.querySelector('.music-player');

        // Upbeat Classy Tracks (Copyright Free / Public Domain)
        const tracks = {
            'spring': { src: "https://upload.wikimedia.org/wikipedia/commons/3/3c/Antonio_Vivaldi_-_Spring_mvt_1_Allegro_-_John_Harrison_violin.ogg", title: "Vivaldi: Spring", genre: "Upbeat Classic" },
            'mozart': { src: "https://upload.wikimedia.org/wikipedia/commons/2/28/Wolfgang_Amadeus_Mozart_-_Eine_kleine_Nachtmusik_-_1._Allegro.ogg", title: "Mozart: Nachtmusik", genre: "Energetic Classic" } 
        };

        function playMusic(type) {
            audio.src = tracks[type].src;
            audio.play().catch(e => alert("ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì¬ìƒì„ ìœ„í•´ í™”ë©´ì„ í•œ ë²ˆ í´ë¦­í•´ì£¼ì„¸ìš”."));
            musicTitle.innerText = tracks[type].title;
            musicGenre.innerText = tracks[type].genre;
            musicPlayerDiv.classList.add('playing');
        }

        function stopMusic() {
            audio.pause();
            musicTitle.innerText = "Music Paused";
            musicPlayerDiv.classList.remove('playing');
        }

        // --- Simulated AI Knowledge Base (Expanded x8) ---
        const knowledgeBase = {
            'method': `<strong>[ì—°êµ¬ ì„¤ê³„]</strong> KNHANES ì œ9ê¸°(2022-2024) ë°ì´í„°ë¥¼ í™œìš©í•˜ë©°, ë§Œ 19-64ì„¸ ì„±ì¸ì„ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤. ì‹ ì¥ ê¸°ëŠ¥ì€ CKD-EPI (2021) ê³µì‹ì„ í†µí•´ ì‚°ì¶œëœ eGFRë¡œ í‰ê°€í•˜ë©°, ë³µí•©í‘œë³¸ ë‹¤ì¤‘íšŒê·€ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.`,
            'coffee_diff': `<strong>[ì»¤í”¼ ìœ í˜•ë³„ ì°¨ì´]</strong> ë¸”ë™ì»¤í”¼ëŠ” í•­ì‚°í™” ì„±ë¶„(í´ë¦¬í˜ë†€)ìœ¼ë¡œ ì¸í•´ ì‹ ì¥ ë³´í˜¸ íš¨ê³¼ê°€ ê¸°ëŒ€ë˜ë‚˜, ë¯¹ìŠ¤ì»¤í”¼ëŠ” ì„¤íƒ•ê³¼ í”„ë¦¼ìœ¼ë¡œ ì¸í•œ ëŒ€ì‚¬ì¦í›„êµ° ìœ„í—˜ ì¦ê°€ë¡œ ì‹ ì¥ì— ë¶€ì •ì ì¼ ìˆ˜ ìˆë‹¤ëŠ” ê°€ì„¤ì„ ê²€ì¦í•©ë‹ˆë‹¤.`,
            'tea_timing': `<strong>[ì°¨ ì„­ì·¨ íƒ€ì´ë°]</strong> 11ì›” ì—°êµ¬ë…¸íŠ¸ì— ë”°ë¥´ë©´, ì‹ ì¥ ëŒ€ì‚¬ í™œë™ì´ í™œë°œí•œ 'ì˜¤ì „ ì‹œê°„ëŒ€(ìƒˆë²½~ì •ì˜¤)'ì— ì°¨ë¥¼ ì„­ì·¨í•  ê²½ìš° eGFR ìœ ì§€ì— ê°€ì¥ ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.`,
            'mechanism': `<strong>[ì‘ìš© ê¸°ì „]</strong> ì»¤í”¼ì˜ í´ë¡œë¡œê²ì‚°ì€ ì‚°í™” ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ì´ê³ , ì¹´í˜ì¸ì€ ì•„ë°ë…¸ì‹  ìˆ˜ìš©ì²´ë¥¼ ì°¨ë‹¨í•˜ì—¬ ì‹ ì¥ì˜ ì‚°ì†Œ ì†Œë¹„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤. ë°˜ë©´ ê³¼ë‹¹(Fructose)ì€ ìš”ì‚°ì„ ì¦ê°€ì‹œì¼œ í•´ë¡­ìŠµë‹ˆë‹¤.`,
            'diabetes': `<strong>[ë‹¹ë‡¨ í™˜ì]</strong> Tang et al. (2024) ì—°êµ¬ì— ë”°ë¥´ë©´, ë‹¹ë‡¨ í™˜ìëŠ” ê¸°ìƒ í›„ 1ì‹œê°„ ì´ë‚´ì— ì»¤í”¼ë¥¼ ì„­ì·¨í–ˆì„ ë•Œ ì‹ ì¥ ë³´í˜¸ íš¨ê³¼ê°€ ê°€ì¥ ì»¸ìŠµë‹ˆë‹¤. ë‹¨, ë¯¹ìŠ¤ì»¤í”¼ëŠ” í˜ˆë‹¹ ê´€ë¦¬ì— ì¹˜ëª…ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
            'gender': `<strong>[ì„±ë³„ ì°¨ì´]</strong> ì—¬ì„±ì€ ì—ìŠ¤íŠ¸ë¡œê²ì´ ì¹´í˜ì¸ ëŒ€ì‚¬ë¥¼ ì§€ì—°ì‹œì¼œ ì²´ë‚´ ë†ë„ë¥¼ ìœ ì§€í•˜ê³ , ì‹ ì¥ ì¡°ì§ì˜ ì‚°í™” ì†ìƒì„ ë°©ì–´í•˜ëŠ” í˜¸ë¥´ëª¬ íš¨ê³¼ë¡œ ì¸í•´ ë‚¨ì„±ë³´ë‹¤ ëšœë ·í•œ ì´ì ì„ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
            'conclusion': `<strong>[ì ì • ê²°ë¡ ]</strong> 'ì ì ˆí•œ ë¸”ë™ì»¤í”¼(í•˜ë£¨ 2-3ì”)'ì™€ 'ì˜¤ì „ì˜ ì°¨ í•œ ì”'ì€ ì‹ ì¥ ê±´ê°•ì— ìœ ìµí•  ìˆ˜ ìˆìœ¼ë‚˜, ê°€ë‹¹ìŒë£Œì™€ ë¯¹ìŠ¤ì»¤í”¼ëŠ” ëª…ë°±í•œ ìœ„í—˜ ì¸ìì…ë‹ˆë‹¤.`,
            'limitation': `<strong>[í•œê³„ì ]</strong> ë‹¨ë©´ ì—°êµ¬(Cross-sectional) íŠ¹ì„±ìƒ ì¸ê³¼ê´€ê³„ ì¦ëª…ì´ ì–´ë µê³ , ì„¤ë¬¸(FFQ)ì— ì˜ì¡´í•œ ì„­ì·¨ëŸ‰ ì¡°ì‚¬ëŠ” ê¸°ì–µ í¸í–¥(Recall Bias)ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`
        };

        function askAI(key) {
            const chatWindow = document.getElementById('chat-window');
            const userTexts = {
                'method': "ì—°êµ¬ ë°ì´í„°ì™€ ë°©ë²•ë¡ ì€?", 'coffee_diff': "ë¯¹ìŠ¤ì»¤í”¼ì™€ ë¸”ë™ì»¤í”¼ì˜ ì°¨ì´ëŠ”?", 'tea_timing': "ì°¨ëŠ” ì–¸ì œ ë§ˆì‹œëŠ” ê²Œ ì¢‹ì•„?",
                'mechanism': "ì–´ë–¤ ì›ë¦¬ë¡œ ì‹ ì¥ì— ì¢‹ì•„?", 'diabetes': "ë‹¹ë‡¨ í™˜ìì—ê²ŒëŠ” ì–´ë•Œ?", 'gender': "ë‚¨ë…€ ì°¨ì´ê°€ ìˆì–´?",
                'conclusion': "ê·¸ë˜ì„œ ê²°ë¡ ì´ ë­ì•¼?", 'limitation': "ì—°êµ¬ì˜ í•œê³„ëŠ”?"
            };

            chatWindow.innerHTML += `<div class="flex gap-3 justify-end chat-bubble"><div class="bg-indigo-500 text-white p-3.5 rounded-2xl rounded-tr-none text-xs shadow-md font-medium">${userTexts[key]}</div></div>`;
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const loadingId = 'loading-' + Date.now();
            chatWindow.innerHTML += `<div id="${loadingId}" class="flex gap-3 chat-bubble mt-2"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500/10 flex items-center justify-center text-sm border border-indigo-500/20">ğŸ‘©â€ğŸ’»</div><div class="glass-panel p-3 rounded-2xl rounded-tl-none border border-slate-500/10"><div class="flex gap-1"><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span><span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span></div></div></div>`;
            chatWindow.scrollTop = chatWindow.scrollHeight;

            setTimeout(() => {
                document.getElementById(loadingId).remove();
                chatWindow.innerHTML += `<div class="flex gap-3 chat-bubble"><div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500/10 flex items-center justify-center text-sm border border-indigo-500/20">ğŸ‘©â€ğŸ’»</div><div class="glass-panel p-4 rounded-2xl rounded-tl-none text-xs opacity-90 leading-relaxed max-w-[88%] border border-slate-500/10 shadow-sm">${knowledgeBase[key]}</div></div>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, 600);
        }

        // --- Charts Implementation (Plotly & Chart.js) ---
        let doseChart;

        function initCharts() {
            initDoseChart();
            initBubbleChart();
        }

        // 1. Plotly Bubble Chart (Evidence Galaxy) - 12 Papers
        function initBubbleChart() {
            const papers = [
                // International
                { author: "Mazidi", year: 2022, n: 12385, type: "Cross", text: "NHANES (MR)" },
                { author: "Gao", year: 2025, n: 49827, type: "Cross", text: "NHANES" },
                { author: "Guo", year: 2025, n: 99744, type: "Cohort", text: "JACC (Japan)" },
                { author: "Hu", year: 2018, n: 14209, type: "Cohort", text: "ARIC (USA)" },
                { author: "Tang", year: 2022, n: 359906, type: "Cohort", text: "UK Biobank" },
                { author: "Kanbay", year: 2021, n: 505841, type: "Meta", text: "Meta-analysis" },
                { author: "van Westing", year: 2023, n: 5447, type: "Cohort", text: "Rotterdam" },
                { author: "Tang (Dia)", year: 2024, n: 8564, type: "Cross", text: "NHANES (Diabetic)" },
                // Korean (Domestic)
                { author: "Jhee", year: 2018, n: 8717, type: "Cohort", text: "KoGES (Korea)" },
                { author: "Kim", year: 2013, n: 2673, type: "Cross", text: "KNHANES IV (Women)" },
                { author: "Shin", year: 2018, n: 2110, type: "Cross", text: "KNHANES 2014" },
                { author: "Park", year: 2018, n: 3500, type: "Cross", text: "KNHANES 13-14" } // Approx N
            ];

            const trace = {
                x: papers.map(p => p.year),
                y: papers.map(p => p.n),
                text: papers.map(p => p.author),
                mode: 'markers',
                marker: {
                    size: papers.map(p => Math.sqrt(p.n)/4),
                    sizemode: 'area',
                    color: isDarkMode ? '#6366f1' : '#db2777',
                    opacity: 0.7
                }
            };

            const layout = {
                margin: {t:10, l:40, r:10, b:40},
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { title: 'Publication Year', color: isDarkMode ? '#94a3b8' : '#64748b' },
                yaxis: { title: 'Participants (Log)', type: 'log', color: isDarkMode ? '#94a3b8' : '#64748b' },
                hovermode: 'closest'
            };

            Plotly.newPlot('bubbleChart', [trace], layout, {displayModeBar: false, responsive: true});
            
            document.getElementById('bubbleChart').on('plotly_click', function(data){
                const idx = data.points[0].pointIndex;
                const p = papers[idx];
                const panel = document.getElementById('study-detail-panel');
                panel.classList.remove('hidden');
                document.getElementById('detail-title').innerText = `${p.author} et al. (${p.year})`;
                document.getElementById('detail-desc').innerText = `N=${p.n.toLocaleString()} (${p.type}). Source: ${p.text}`;
            });
        }

        // 2. Chart.js Dose-Response Line Chart
        function initDoseChart() {
            const ctx = document.getElementById('doseChart').getContext('2d');
            doseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0ì”', '1ì”', '2ì”', '3ì”', '4ì”', '5ì”+'],
                    datasets: [{
                        label: 'CKD ìœ„í—˜ë„ (1.0=ê¸°ì¤€)',
                        data: [1.0, 0.92, 0.85, 0.78, 0.76, 0.82],
                        borderColor: isDarkMode ? '#fbbf24' : '#db2777', // Amber vs Pink
                        backgroundColor: isDarkMode ? 'rgba(251, 191, 36, 0.1)' : 'rgba(219, 39, 119, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 0.6, max: 1.1, grid: { display: false }, ticks: { color: 'rgba(150,150,150,0.5)' } },
                        x: { grid: { display: false }, ticks: { color: 'rgba(150,150,150,0.5)' } }
                    }
                }
            });
        }

        function updateChartColors(isDark) {
            if(doseChart) {
                doseChart.data.datasets[0].borderColor = isDark ? '#fbbf24' : '#db2777';
                doseChart.data.datasets[0].backgroundColor = isDark ? 'rgba(251, 191, 36, 0.1)' : 'rgba(219, 39, 119, 0.1)';
                doseChart.update();
            }
        }

        // --- Slider Interaction ---
        const slider = document.getElementById('cup-slider');
        const display = document.getElementById('cup-display');
        const insight = document.getElementById('insight-box');
        const insights = [
            "ê¸°ì¤€ì ì…ë‹ˆë‹¤. ì»¤í”¼ í´ë¦¬í˜ë†€ì˜ ì´ì ì´ ì—†ìŠµë‹ˆë‹¤.",
            "ì•½ê°„ì˜ ì´ì . Tang et al. (2024)ì€ ì´ë•Œ ì„­ì·¨ íƒ€ì´ë°ì´ ì¤‘ìš”í•˜ë‹¤ê³  ì œì•ˆí•©ë‹ˆë‹¤.",
            "ìœ ì˜ë¯¸í•œ êµ¬ê°„. í•­ì‚°í™” íš¨ê³¼ê°€ ë³¸ê²©ì ìœ¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.",
            "ìµœì ì˜ ë²”ìœ„ (Sweet Spot). CKD ë°œìƒ ìœ„í—˜ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤.",
            "ë†’ì€ ë³´í˜¸ íš¨ê³¼. í•˜ì§€ë§Œ ì¹´í˜ì¸ ë¯¼ê°ì„±ì„ ê³ ë ¤í•´ì•¼ í•©ë‹ˆë‹¤.",
            "íš¨ê³¼ê°€ í‰íƒ„í•´ì§€ê±°ë‚˜ ë¶€ì‘ìš©(ë¶ˆë©´ ë“±)ì´ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "ê³¼ë‹¤ ì„­ì·¨ ì£¼ì˜ êµ¬ê°„ì…ë‹ˆë‹¤."
        ];

        slider.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            display.innerText = val === 6 ? "6+" : val;
            insight.innerText = insights[Math.min(val, 6)];
            
            // Highlight point on chart
            const colors = new Array(6).fill(isDarkMode ? 'white' : 'white');
            colors[Math.min(val, 5)] = isDarkMode ? '#fbbf24' : '#db2777';
            doseChart.data.datasets[0].pointBackgroundColor = colors;
            doseChart.data.datasets[0].pointRadius = colors.map(c => c === 'white' ? 4 : 8);
            doseChart.update();
        });

        // --- Simulator Game Logic ---
        const counts = { black: 0, tea: 0, mix: 0, ssb: 0 };
        const states = [
            { limit: 30, title: "ìœ„í—˜ (High Risk)", color: "from-rose-600 to-red-500", desc: "ë‹¹ë¶„ ê³¼ë‹¤! ê°€ë‹¹ìŒë£Œì™€ ë¯¹ìŠ¤ì»¤í”¼ë¥¼ ì¤„ì´ì„¸ìš”." },
            { limit: 60, title: "ì£¼ì˜ (Caution)", color: "from-amber-500 to-orange-400", desc: "ë¯¹ìŠ¤ì»¤í”¼ ì„­ì·¨ë¥¼ ë¸”ë™ì»¤í”¼ë¡œ ë°”ê¿”ë³´ì„¸ìš”." },
            { limit: 85, title: "ì–‘í˜¸ (Good)", color: "from-blue-500 to-indigo-400", desc: "ì¢‹ìŠµë‹ˆë‹¤. ìˆ˜ë¶„ ì„­ì·¨ë¥¼ ìœ ì§€í•˜ì„¸ìš”." },
            { limit: 101, title: "ìµœì  (Optimal)", color: "from-emerald-500 to-teal-400", desc: "ì‹ ì¥ ê±´ê°•ì— ê°€ì¥ ì´ìƒì ì¸ íŒ¨í„´ì…ë‹ˆë‹¤!" }
        ];

        window.addDrink = (t) => { 
            counts[t]++;
            animateChar(t);
            updateUI(t); 
        };

        window.removeDrink = (t, e) => {
            if(e) e.stopPropagation(); // prevent adding when clicking remove
            if(counts[t] > 0) {
                counts[t]--;
                animateChar('remove');
                updateUI(t);
            }
        };
        
        window.resetDrinks = () => { for(let k in counts) counts[k]=0; updateUI(); };
        window.pokeKidney = () => { animateChar('poke'); };

        function animateChar(type) {
            const char = document.getElementById('kidney-char');
            // Reset animation
            char.classList.remove('animate__headShake', 'animate__rubberBand', 'animate__wobble');
            void char.offsetWidth; // Trigger reflow

            if(type === 'mix' || type === 'ssb') char.classList.add('animate__headShake');
            else if(type === 'remove') char.classList.add('animate__wobble'); // Shake when removing
            else char.classList.add('animate__rubberBand');
        }

        function updateUI(t) {
            if(t) document.getElementById(`count-${t}`).innerText = counts[t] + "ì”";
            else document.querySelectorAll('[id^="count-"]').forEach(e=>e.innerText='0ì”');
            
            let score = 100 + (counts.black*2) + (counts.tea*3) - (counts.mix*5) - (counts.ssb*10);
            if(document.getElementById('check-diabetes').checked) score -= (counts.mix*2 + counts.ssb*5);
            score = Math.max(0, Math.min(100, score));
            
            const s = states.find(s => score < s.limit) || states[3];
            document.getElementById('score-val').innerText = score + "ì ";
            document.getElementById('status-badge').innerText = s.title;
            document.getElementById('status-desc').innerText = s.desc;
            document.getElementById('health-bar').style.width = `${score}%`;
            document.getElementById('health-bar').className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r ${s.color}`;
        }
        window.updateKidneyStatus = () => updateUI();

        // --- Advanced Particle System (Day/Night) ---
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        let particles = [];
        let animationFrameId;

        function resize() { width = canvas.width = window.innerWidth; height = canvas.height = window.innerHeight; }
        window.addEventListener('resize', resize);
        
        class Particle {
            constructor(type) { this.type = type; this.init(); }
            init() {
                this.x = Math.random() * width; this.y = Math.random() * height;
                this.size = Math.random() * (this.type === 'sakura' ? 6 : 2);
                this.speedX = (Math.random() - 0.5) * (this.type === 'sakura' ? 1.5 : 0.2);
                this.speedY = Math.random() * (this.type === 'sakura' ? 2 : 0.2) + 0.1;
                this.opacity = Math.random() * 0.5 + 0.2;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = (Math.random() - 0.5) * 2;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                if(this.type === 'sakura') { this.rotation += this.rotationSpeed; this.x += Math.sin(this.y * 0.01) * 0.5; }
                if (this.y > height) this.y = -10; if (this.x > width) this.x = 0; if (this.x < 0) this.x = width;
            }
            draw() {
                ctx.save(); ctx.globalAlpha = this.opacity;
                if(this.type === 'sakura') {
                    ctx.translate(this.x, this.y); ctx.rotate(this.rotation * Math.PI / 180);
                    ctx.fillStyle = '#FDA4AF'; 
                    ctx.beginPath(); 
                    ctx.moveTo(0,0); ctx.bezierCurveTo(this.size/2, -this.size/2, this.size, 0, 0, this.size); 
                    ctx.bezierCurveTo(-this.size, 0, -this.size/2, -this.size/2, 0, 0); 
                    ctx.fill();
                } else {
                    ctx.fillStyle = '#FFFFFF'; ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
                }
                ctx.restore();
            }
        }

        function initParticles(type) {
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            particles = [];
            const count = type === 'sakura' ? 50 : 80;
            for(let i=0; i<count; i++) particles.push(new Particle(type));
            animate();
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => { p.update(); p.draw(); });
            animationFrameId = requestAnimationFrame(animate);
        }

        // --- Init ---
        resize();
        initCharts();
        initParticles('sakura'); // Start with Day Mode
    </script>
</body>
</html>
