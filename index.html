<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026: Researcher Haneulssi</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Plotly.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <!-- Font: Pretendard & Noto Sans KR -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Day Theme (Sakura - Default) */
            --bg-color: #FFF1F2;
            --text-color: #4A044E;
            --card-bg: rgba(255, 255, 255, 0.7);
            --card-border: rgba(251, 113, 133, 0.2);
            --accent-primary: #db2777;
            --accent-secondary: #f472b6;
            --particle-color: 251, 113, 133;
        }

        [data-theme="dark"] {
            /* Night Theme */
            --bg-color: #0F172A;
            --text-color: #F1F5F9;
            --card-bg: rgba(30, 41, 59, 0.6);
            --card-border: rgba(255, 255, 255, 0.05);
            --accent-primary: #6366f1;
            --accent-secondary: #38bdf8;
            --particle-color: 255, 255, 255;
        }

        body {
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: background-color 0.8s ease, color 0.5s ease;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism Logic */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            transition: transform 0.3s ease, background 0.5s ease, border-color 0.5s ease, box-shadow 0.3s ease;
        }
        
        .glass-header {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--card-border);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--accent-secondary) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: all 0.5s ease;
        }

        /* Particle Canvas */
        #particle-canvas {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0;
        }
        
        /* Chat Bubble Animation */
        .chat-bubble {
            animation: fadeInUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0; transform: translateY(10px);
        }
        
        @keyframes fadeInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        .suggestion-chip {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .suggestion-chip:active {
            transform: scale(0.92);
        }
        
        /* Music Player */
        .music-player {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            transition: all 0.3s ease;
        }
        .music-disc {
            animation: spin 4s linear infinite;
            animation-play-state: paused;
        }
        .playing .music-disc { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Floating Score Animation */
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translate(-50%, 0) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -40px) scale(1.2); }
        }
        .floating-score {
            position: absolute;
            left: 50%;
            top: 40%;
            font-weight: 800;
            font-size: 1.5rem;
            pointer-events: none;
            animation: floatUpFade 0.8s ease-out forwards;
            z-index: 50;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Floating Animation for Abstract */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }
        
        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px; width: 20px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px;
            cursor: pointer;
            background: rgba(150, 150, 150, 0.3);
            border-radius: 2px;
        }
    </style>
</head>
<body class="antialiased pb-28 relative" data-theme="light">

    <canvas id="particle-canvas"></canvas>

    <!-- Navigation -->
    <nav class="sticky top-0 z-50 glass-header">
        <div class="max-w-3xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-500/10 p-2 rounded-xl border border-indigo-500/20 shadow-sm">
                        <i class="ph-fill ph-student text-2xl" style="color: var(--accent-primary)"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg leading-none tracking-tight">Haneulssi's Lab</h1>
                        <p class="text-[10px] opacity-70 mt-1 font-medium tracking-wide uppercase">Nutrition Epidemiology</p>
                    </div>
                </div>
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2.5 rounded-full bg-slate-500/10 hover:bg-slate-500/20 transition active:rotate-180 duration-500">
                    <i id="theme-icon" class="ph-fill ph-flower-lotus text-xl text-pink-500"></i>
                </button>
            </div>
            <!-- Tabs -->
            <div class="flex gap-2 overflow-x-auto hide-scrollbar mt-3 pb-1 px-1">
                <a href="#abstract" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-indigo-500/10 text-[var(--accent-primary)] border border-indigo-500/20 hover:bg-indigo-500/20 transition">ì—°êµ¬ ê°œìš”</a>
                <a href="#results" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">ë¶„ì„ ê²°ê³¼</a>
                <a href="#dose-response" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">ë°˜ì‘í˜• ëª¨ë¸</a>
                <a href="#simulator" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">ì‹œë®¬ë ˆì´í„°</a>
                <a href="#chat" class="flex-shrink-0 px-4 py-2 text-xs font-bold rounded-full bg-slate-500/5 opacity-70 border border-slate-500/10 hover:opacity-100 transition">AI ë¦¬í¬íŠ¸</a>
            </div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto px-4 py-6 space-y-10 relative z-10">

        <!-- 1. Abstract -->
        <section id="abstract" class="space-y-4 animate__animated animate__fadeIn">
            <div class="glass-panel p-6 relative overflow-hidden group">
                <div class="absolute -top-12 -right-12 w-48 h-48 bg-gradient-to-br from-[var(--accent-primary)] to-[var(--accent-secondary)] rounded-full blur-[70px] opacity-20 group-hover:opacity-30 transition duration-700 animate-float"></div>
                
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="px-2.5 py-1 rounded-md text-[10px] font-bold bg-sky-500/10 text-sky-500 border border-sky-500/20 backdrop-blur-sm">2026 KNHANES PROJECT</span>
                    </div>
                    <h2 class="text-2xl font-extrabold mb-4 leading-snug">
                        Association between <span class="gradient-text">Beverage Consumption</span><br>
                        and Kidney Function
                    </h2>
                    <p class="text-sm opacity-80 leading-relaxed mb-5 font-light">
                        í•œêµ­ ì„±ì¸ì˜ ìŒë£Œ ì„­ì·¨ íŒ¨í„´ì´ ì‹ ì¥ ê¸°ëŠ¥(eGFR)ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ë¶„ì„í•©ë‹ˆë‹¤.
                    </p>
                    <div class="grid grid-cols-2 gap-3 pt-4 border-t border-dashed border-gray-500/20">
                        <div class="hover:bg-white/5 p-2 rounded-lg transition">
                            <h3 style="color: var(--accent-secondary)" class="font-bold mb-1 text-xs tracking-wider">OBJECTIVE</h3>
                            <p class="text-[11px] opacity-70">ë¯¹ìŠ¤ì»¤í”¼ vs ë¸”ë™ì»¤í”¼<br>ì°¨ë³„ì  ì˜í–¥ ê·œëª…</p>
                        </div>
                        <div class="hover:bg-white/5 p-2 rounded-lg transition">
                            <h3 style="color: var(--accent-secondary)" class="font-bold mb-1 text-xs tracking-wider">DATA SOURCE</h3>
                            <p class="text-[11px] opacity-70">KNHANES ì œ9ê¸°<br>(2022-2024)</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. Results: Evidence Galaxy (Plotly) -->
        <section id="results" class="space-y-4">
            <div class="flex items-center gap-2 px-1 mb-2">
                <i class="ph-fill ph-planet text-amber-500 text-lg"></i>
                <h3 class="text-base font-bold">ì¦ê±°ì˜ ì€í•˜ê³„ (Evidence Galaxy)</h3>
            </div>
            <div class="glass-panel p-4 relative overflow-hidden">
                <p class="text-[11px] opacity-60 mb-2 px-1">ì´ 12í¸ì˜ í•µì‹¬ ë…¼ë¬¸ ë¶„í¬ (ì› í¬ê¸° = í‘œë³¸ ìˆ˜)</p>
                <!-- Plotly Chart Container -->
                <div id="bubbleChart" class="w-full h-[400px]"></div>
                <!-- Interactive Detail Panel -->
                <div id="study-detail-panel" class="hidden mt-3 bg-white/50 border-l-4 border-amber-500 p-3 rounded-r-lg backdrop-blur-sm transition-all text-xs">
                    <h4 id="detail-title" class="font-bold mb-1">ë…¼ë¬¸ ì œëª©</h4>
                    <p id="detail-desc" class="opacity-80 leading-snug">ì„¤ëª…...</p>
                </div>
            </div>
        </section>

        <!-- 3. Dose-Response Model (Interactive) -->
        <section id="dose-response" class="space-y-4">
            <div class="flex items-center gap-2 px-1 mb-2">
                <i class="ph-fill ph-faders text-emerald-500 text-lg"></i>
                <h3 class="text-base font-bold">ìš©ëŸ‰-ë°˜ì‘ ëª¨ë¸ (Dose-Response)</h3>
            </div>
            
            <div class="glass-panel p-6">
                <div class="mb-6">
                    <h4 class="text-sm font-bold opacity-90 mb-1">í•˜ë£¨ ì»¤í”¼ ì„­ì·¨ëŸ‰ ì‹œë®¬ë ˆì´ì…˜</h4>
                    <p class="text-[11px] opacity-60">ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ CKD ìœ„í—˜ë„ ë³€í™”ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>
                </div>

                <!-- Slider Control -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-3xl font-bold" style="color: var(--accent-primary)" id="cup-display">0</span>
                        <span class="text-xs font-bold opacity-50 uppercase tracking-widest">Cups / Day</span>
                    </div>
                    <input type="range" min="0" max="6" value="0" step="1" id="cup-slider" class="w-full">
                    <div class="flex justify-between text-[10px] opacity-40 mt-2 font-mono">
                        <span>0</span><span>2</span><span>4</span><span>6+</span>
                    </div>
                    <!-- Insight Box -->
                    <div id="insight-box" class="mt-4 p-3 bg-indigo-500/5 rounded-xl border border-indigo-500/10 text-xs opacity-80 leading-relaxed font-medium transition-all">
                        ê¸°ì¤€ì ì…ë‹ˆë‹¤. ì»¤í”¼ í´ë¦¬í˜ë†€ì˜ ì´ì ì´ ì•„ì§ ì ìš©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                    </div>
                </div>

                <!-- Line Chart -->
                <div class="h-[250px] w-full bg-white/30 rounded-xl p-2">
                    <canvas id="doseChart"></canvas>
                </div>
                <p class="text-[9px] opacity-40 mt-2 text-right">*Based on Meta-analysis (Gao et al., 2025)</p>
            </div>
        </section>

        <!-- 4. Simulator (Tamagotchi) -->
        <section id="simulator" class="glass-panel p-6 relative overflow-hidden">
            <div class="flex items-center justify-between mb-8 relative z-10">
                <div>
                    <h2 class="text-base font-bold flex items-center gap-2">
                        <i class="ph-fill ph-flask" style="color: var(--accent-primary)"></i> ì‹ ì¥ ë‹¤ë§ˆê³ ì¹˜
                    </h2>
                    <p class="opacity-60 text-[10px] mt-1 ml-6">ì»¤í”¼, ì°¨, ê°€ë‹¹ìŒë£Œ í†µí•© ë¶„ì„</p>
                </div>
                <button onclick="window.resetDrinks()" class="text-[10px] font-bold bg-slate-500/10 hover:bg-slate-500/20 px-3 py-1.5 rounded-lg transition flex items-center gap-1 active:scale-95">
                    <i class="ph-bold ph-arrow-counter-clockwise"></i> ì´ˆê¸°í™”
                </button>
            </div>

            <div class="flex flex-col items-center gap-8 relative z-10">
                <!-- Character & Bar -->
                <div class="flex flex-col items-center justify-center w-full relative" style="min-height: 200px;">
                    <div class="relative mb-6 group">
                        <div class="absolute inset-0 bg-emerald-500/20 rounded-full blur-2xl opacity-0 group-hover:opacity-50 transition duration-500"></div>
                        <!-- Character: Added onclick to animate manually as well -->
                        <div id="kidney-char" class="text-[90px] transition-all duration-300 drop-shadow-2xl cursor-pointer select-none hover:scale-110 active:scale-90 relative z-10" onclick="window.pokeKidney()">ğŸ«˜</div>
                        
                        <!-- Floating Score Container -->
                        <div id="score-float-container" class="absolute inset-0 pointer-events-none z-20"></div>

                        <div id="status-badge" class="absolute -top-2 -right-8 bg-emerald-500 text-white text-[10px] font-bold px-2.5 py-1 rounded-full shadow-lg animate-bounce border border-white/20">
                            ìµœì ìƒíƒœ
                        </div>
                    </div>
                    
                    <div class="w-full space-y-2.5">
                        <div class="flex justify-between text-xs font-bold opacity-80 px-1">
                            <span>ê±´ê°• ì ìˆ˜</span>
                            <span id="score-val" class="text-emerald-500">100ì </span>
                        </div>
                        <div class="w-full bg-slate-500/10 rounded-full h-3.5 overflow-hidden ring-1 ring-slate-500/5">
                            <div id="health-bar" class="bg-gradient-to-r from-emerald-500 to-teal-400 h-full w-full transition-all duration-700 relative shadow-[0_0_10px_rgba(16,185,129,0.3)]">
                                <div class="absolute inset-0 bg-white/20 animate-[shimmer_2s_infinite]"></div>
                            </div>
                        </div>
                        <p id="status-desc" class="text-center text-[11px] opacity-70 mt-1 font-medium">í•­ì‚°í™” íš¨ê³¼ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>
                </div>

                <!-- Controls -->
                <div class="w-full grid grid-cols-2 gap-3">
                    <!-- Tea -->
                    <div class="relative group">
                        <button onclick="window.addDrink('tea')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-emerald-500/5 transition active:scale-[0.97] border-emerald-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">ğŸµ</span>
                            <div class="text-[11px] font-bold mt-1">ë…¹ì°¨/í™ì°¨</div>
                            <div class="text-[9px] text-emerald-500 font-medium">+3ì </div>
                            <div id="count-tea" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('tea', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>

                    <!-- Black Coffee -->
                    <div class="relative group">
                        <button onclick="window.addDrink('black')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-indigo-500/5 transition active:scale-[0.97] border-indigo-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">â˜•</span>
                            <div class="text-[11px] font-bold mt-1">ë¸”ë™ì»¤í”¼</div>
                            <div class="text-[9px] text-indigo-500 font-medium">+2ì </div>
                            <div id="count-black" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('black', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>

                    <!-- Mix Coffee -->
                    <div class="relative group">
                        <button onclick="window.addDrink('mix')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-amber-500/5 transition active:scale-[0.97] border-amber-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">ğŸ¬</span>
                            <div class="text-[11px] font-bold mt-1">ë¯¹ìŠ¤ì»¤í”¼</div>
                            <div class="text-[9px] text-amber-500 font-medium">-5ì </div>
                            <div id="count-mix" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('mix', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>

                    <!-- SSB -->
                    <div class="relative group">
                        <button onclick="window.addDrink('ssb')" class="w-full glass-panel p-3.5 flex flex-col items-center hover:bg-rose-500/5 transition active:scale-[0.97] border-rose-500/10">
                            <span class="text-3xl mb-1 group-hover:-translate-y-1 transition duration-300">ğŸ¥¤</span>
                            <div class="text-[11px] font-bold mt-1">íƒ„ì‚°/ì£¼ìŠ¤</div>
                            <div class="text-[9px] text-rose-500 font-medium">-10ì </div>
                            <div id="count-ssb" class="text-[9px] mt-1 opacity-40 font-mono">0ì”</div>
                        </button>
                        <button onclick="window.removeDrink('ssb', event)" class="absolute top-1 right-1 w-6 h-6 flex items-center justify-center bg-slate-500/10 hover:bg-rose-500/20 rounded-full text-slate-500 hover:text-rose-500 text-xs transition z-20" title="ì·¨ì†Œ">-</button>
                    </div>
                </div>

                <label class="flex items-center gap-3 p-4 w-full bg-slate-500/5 rounded-xl cursor-pointer transition select-none hover:bg-slate-500/10">
                    <div class="relative flex items-center">
                        <input type="checkbox" id="check-diabetes" class="peer sr-only" onchange="window.updateKidneyStatus()">
                        <div class="w-9 h-5 bg-slate-400/30 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-rose-500"></div>
                    </div>
                    <span class="text-xs font-bold opacity-80">ë‹¹ë‡¨ë³‘ í™˜ìêµ° (Risk Factor)</span>
                </label>
            </div>
        </section>

        <!-- 5. AI Assistant -->
        <section id="chat" class="glass-panel flex flex-col h-[600px] overflow-hidden shadow-xl">
            <div class="p-4 border-b border-gray-500/10 flex justify-between items-center bg-gray-500/5 backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-2.5 h-2.5 bg-emerald-500 rounded-full absolute -right-0.5 -bottom-0.5 border-2 border-white animate-pulse"></div>
                        <span class="text-2xl">ğŸ‘©â€ğŸ’»</span>
                    </div>
                    <div>
                        <span class="font-bold text-sm block">Researcher haneulssi</span>
                        <span class="text-[10px] opacity-70 block font-bold tracking-wide">AI Assistant</span>
                    </div>
                </div>
            </div>
            
            <div id="chat-window" class="flex-1 p-5 overflow-y-auto space-y-5 bg-transparent scroll-smooth">
                <div class="flex gap-3 animate__animated animate__fadeIn">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500/10 flex items-center justify-center text-sm border border-indigo-500/20">ğŸ‘©â€ğŸ’»</div>
                    <div class="glass-panel p-3.5 rounded-tl-none text-xs opacity-90 leading-relaxed max-w-[88%] shadow-sm">
                        ì•ˆë…•í•˜ì„¸ìš”! <strong>Researcher haneulssi</strong>ì…ë‹ˆë‹¤.<br><br>
                        2025-2026 ì—°êµ¬ë…¸íŠ¸ì™€ ì„ í–‰ ë…¼ë¬¸ì„ ëª¨ë‘ í•™ìŠµí–ˆìŠµë‹ˆë‹¤.<br>
                        ê¶ê¸ˆí•œ ì ì„ ì•„ë˜ ì¹©ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ“š
                    </div>
                </div>
            </div>
            
            <!-- Quick Chips & Input Area -->
            <div class="p-4 border-t border-gray-500/10 bg-gray-500/5 backdrop-blur-md flex flex-col gap-3">
                <p class="text-[10px] opacity-50 mb-3 font-bold ml-1 uppercase tracking-wider">Tap to ask:</p>
                <div class="flex flex-col gap-2.5">
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                        <button onclick="askAI('method')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-indigo-500/10 hover:bg-indigo-500/20 text-[11px] font-bold rounded-xl border border-indigo-500/20 text-indigo-500">ğŸ”¬ ì—°êµ¬ ë°©ë²•</button>
                        <button onclick="askAI('coffee_diff')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-amber-500/10 hover:bg-amber-500/20 text-[11px] font-bold rounded-xl border border-amber-500/20 text-amber-500">â˜• ë¯¹ìŠ¤ vs ë¸”ë™</button>
                        <button onclick="askAI('tea_timing')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-emerald-500/10 hover:bg-emerald-500/20 text-[11px] font-bold rounded-xl border border-emerald-500/20 text-emerald-500">â° ì°¨ ì„­ì·¨ íƒ€ì´ë°</button>
                    </div>
                    <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                        <button onclick="askAI('mechanism')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-purple-500/10 hover:bg-purple-500/20 text-[11px] font-bold rounded-xl border border-purple-500/20 text-purple-500">ğŸ§¬ ì‘ìš© ê¸°ì „</button>
                        <button onclick="askAI('diabetes')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-rose-500/10 hover:bg-rose-500/20 text-[11px] font-bold rounded-xl border border-rose-500/20 text-rose-500">ğŸ©¸ ë‹¹ë‡¨ í™˜ì</button>
                        <button onclick="askAI('gender')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-blue-500/10 hover:bg-blue-500/20 text-[11px] font-bold rounded-xl border border-blue-500/20 text-blue-500">ğŸ‘« ì„±ë³„ ì°¨ì´</button>
                        <button onclick="askAI('conclusion')" class="suggestion-chip flex-shrink-0 px-3 py-2 bg-slate-500/10 hover:bg-slate-500/20 text-[11px] font-bold rounded-xl border border-slate-500/20 opacity-70">ğŸ“‘ ê²°ë¡  ìš”ì•½</button>
                    </div>
                </div>
                
                <!-- Custom Input -->
                <div class="relative mt-1">
                    <input type="text" id="user-input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ë¯¹ìŠ¤ì»¤í”¼ ë§ì´ ë§ˆì‹œë©´?)" class="w-full bg-white/50 border border-indigo-200 rounded-xl pl-4 pr-12 py-3 text-xs focus:ring-2 focus:ring-indigo-300 focus:outline-none transition-all placeholder-gray-400" onkeypress="if(event.key==='Enter') sendUserQuery()">
                    <button onclick="sendUserQuery()" class="absolute right-2 top-1.5 p-1.5 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg transition active:scale-95">
                        <i class="ph-bold ph-paper-plane-right text-sm"></i>
                    </button>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <section class="text-center pt-8 pb-4">
            <p class="opacity-50 text-[10px] font-medium tracking-widest uppercase">Â© 2026 Researcher Haneulssi</p>
        </section>

    </main>

    <!-- Music Player Widget -->
    <div class="music-player glass-panel p-2 flex items-center gap-3 pr-4 rounded-full border border-white/20 shadow-xl backdrop-blur-xl">
        <div class="music-disc w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center border-2 border-slate-600 relative overflow-hidden" id="disc-icon">
            <div class="w-2 h-2 bg-white rounded-full z-10"></div>
            <div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/10 to-transparent"></div>
        </div>
        <div class="flex flex-col">
            <span class="text-[10px] font-bold opacity-80" id="music-title">Music Off</span>
            <span class="text-[8px] opacity-50" id="music-genre">Select Genre</span>
        </div>
        <div class="flex gap-2 ml-2">
            <button onclick="playMusic('spring')" class="text-lg hover:scale-110 transition active:scale-95" title="Vivaldi - Spring">ğŸ»</button>
            <button onclick="playMusic('mozart')" class="text-lg hover:scale-110 transition active:scale-95" title="Mozart - Nachtmusik">ğŸ¹</button>
            <button onclick="stopMusic()" class="text-lg hover:scale-110 transition active:scale-95 text-rose-400" title="Stop">â¹ï¸</button>
        </div>
        <audio id="bgm-player" loop></audio>
    </div>

    <script>
        // --- Configuration ---
        const apiKey = ""; // API Key injected by environment

        // --- Theme Logic ---
        let isDarkMode = false; 
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');
        const particleCanvas = document.getElementById('particle-canvas');

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            
            if (isDarkMode) {
                themeIcon.className = 'ph-fill ph-moon-stars text-xl text-yellow-300';
                initParticles('stars');
            } else {
                themeIcon.className = 'ph-fill ph-flower-lotus text-xl text-pink-500';
                initParticles('sakura');
            }
            updateChartColors(isDarkMode);
            initBubbleChart();
        }

        // --- Music Player Logic ---
        const audio = document.getElementById('bgm-player');
        const disc = document.getElementById('disc-icon');
        const musicTitle = document.getElementById('music-title');
        const musicGenre = document.getElementById('music-genre');
        const musicPlayerDiv = document.querySelector('.music-player');

        const tracks = {
            'spring': { src: "https://upload.wikimedia.org/wikipedia/commons/3/3c/Antonio_Vivaldi_-_Spring_mvt_1_Allegro_-_John_Harrison_violin.ogg", title: "Vivaldi: Spring", genre: "Upbeat Classic" },
            'mozart': { src: "https://upload.wikimedia.org/wikipedia/commons/2/28/Wolfgang_Amadeus_Mozart_-_Eine_kleine_Nachtmusik_-_1._Allegro.ogg", title: "Mozart: Nachtmusik", genre: "Energetic Classic" } 
        };

        function playMusic(type) {
            audio.src = tracks[type].src;
            musicTitle.innerText = tracks[type].title;
            musicGenre.innerText = tracks[type].genre;
            musicPlayerDiv.classList.add('playing');
            
            // Standard play attempt
            audio.play().catch(e => {
                console.log("Audio play failed:", e);
                // No alert needed, user just clicked the button
            });
        }

        function stopMusic() {
            audio.pause();
            musicTitle.innerText = "Music Paused";
            musicPlayerDiv.classList.remove('playing');
        }

        // --- AI Logic (Real Gemini API) ---
        const systemPrompt = `
            ë‹¹ì‹ ì€ 'ì¡°í•˜ëŠ˜ ì—°êµ¬ì›(Researcher Haneulssi)'ì˜ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
            2025ë…„ 9ì›”ë¶€í„° 2026ë…„ 1ì›”ê¹Œì§€ ì‘ì„±ëœ ì—°êµ¬ë…¸íŠ¸ì™€ ì„ í–‰ ë…¼ë¬¸ì„ ë°”íƒ•ìœ¼ë¡œ ë‹µë³€í•˜ì„¸ìš”.
            
            [í•µì‹¬ ì—°êµ¬ ë‚´ìš©]
            1. ì£¼ì œ: í•œêµ­ ì„±ì¸ì˜ ìŒë£Œ ì„­ì·¨(ì»¤í”¼, ì°¨, ê°€ë‹¹ìŒë£Œ)ê°€ ì‹ ì¥ ê¸°ëŠ¥(eGFR)ì— ë¯¸ì¹˜ëŠ” ì˜í–¥.
            2. ë°ì´í„°: KNHANES ì œ9ê¸° (2022-2024). ëŒ€ìƒ: 19-64ì„¸ ì„±ì¸.
            3. ê°€ì„¤: ë¸”ë™ì»¤í”¼ëŠ” í•­ì‚°í™” ì„±ë¶„ìœ¼ë¡œ ì‹ ì¥ì— ê¸ì •ì ì´ë‚˜, ë¯¹ìŠ¤ì»¤í”¼(ì„¤íƒ•/í”„ë¦¼)ëŠ” ëŒ€ì‚¬ ìœ„í—˜ìœ¼ë¡œ ë¶€ì •ì ì¼ ê²ƒì„.
            4. ì°¨(Tea): ì˜¤ì „ ì‹œê°„ëŒ€(ìƒˆë²½~ì •ì˜¤) ì„­ì·¨ê°€ ì‹ ì¥ ëŒ€ì‚¬ ë¦¬ë“¬ê³¼ ì¼ì¹˜í•˜ì—¬ eGFR ìœ ì§€ì— ê°€ì¥ íš¨ê³¼ì ì„.
            5. ë‹¹ë‡¨ í™˜ì: ê¸°ìƒ í›„ 1ì‹œê°„ ì´ë‚´ ì»¤í”¼ ì„­ì·¨ê°€ ì‹ ì¥ ë³´í˜¸ì— ìœ ë¦¬í•  ìˆ˜ ìˆìŒ (Tang et al. 2024). ë‹¨, ë¯¹ìŠ¤ì»¤í”¼ëŠ” ê¸ˆë¬¼.
            
            ë‹µë³€ ìŠ¤íƒ€ì¼: ì „ë¬¸ì ì´ì§€ë§Œ ì¹œì ˆí•˜ê²Œ, ì—°êµ¬ì› ì¡°í•˜ëŠ˜ì˜ ê´€ì ì—ì„œ ì„¤ëª…í•˜ì„¸ìš”. í•œêµ­ì–´ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
            ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ê°€ë…ì„±ì„ ë†’ì´ì„¸ìš”.
        `;

        // Local Fallback Knowledge Base (For when API fails)
        const knowledgeBase = {
            'method': `<strong>[ì—°êµ¬ ì„¤ê³„]</strong> KNHANES ì œ9ê¸°(2022-2024) ë°ì´í„°ë¥¼ í™œìš©í•˜ë©°, ë§Œ 19-64ì„¸ ì„±ì¸ì„ ëŒ€ìƒìœ¼ë¡œ í•©ë‹ˆë‹¤. ì‹ ì¥ ê¸°ëŠ¥ì€ CKD-EPI (2021) ê³µì‹ì„ í†µí•´ ì‚°ì¶œëœ eGFRë¡œ í‰ê°€í•˜ë©°, ë³µí•©í‘œë³¸ ë‹¤ì¤‘íšŒê·€ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.`,
            'coffee_diff': `<strong>[ì»¤í”¼ ìœ í˜•ë³„ ì°¨ì´]</strong> ë¸”ë™ì»¤í”¼ëŠ” í•­ì‚°í™” ì„±ë¶„(í´ë¦¬í˜ë†€)ìœ¼ë¡œ ì¸í•´ ì‹ ì¥ ë³´í˜¸ íš¨ê³¼ê°€ ê¸°ëŒ€ë˜ë‚˜, ë¯¹ìŠ¤ì»¤í”¼ëŠ” ì„¤íƒ•ê³¼ í”„ë¦¼ìœ¼ë¡œ ì¸í•œ ëŒ€ì‚¬ì¦í›„êµ° ìœ„í—˜ ì¦ê°€ë¡œ ì‹ ì¥ì— ë¶€ì •ì ì¼ ìˆ˜ ìˆë‹¤ëŠ” ê°€ì„¤ì„ ê²€ì¦í•©ë‹ˆë‹¤.`,
            'tea_timing': `<strong>[ì°¨ ì„­ì·¨ íƒ€ì´ë°]</strong> 11ì›” ì—°êµ¬ë…¸íŠ¸ì— ë”°ë¥´ë©´, ì‹ ì¥ ëŒ€ì‚¬ í™œë™ì´ í™œë°œí•œ 'ì˜¤ì „ ì‹œê°„ëŒ€(ìƒˆë²½~ì •ì˜¤)'ì— ì°¨ë¥¼ ì„­ì·¨í•  ê²½ìš° eGFR ìœ ì§€ì— ê°€ì¥ ê¸ì •ì ì¸ ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ê²ƒìœ¼ë¡œ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤.`,
            'mechanism': `<strong>[ì‘ìš© ê¸°ì „]</strong> ì»¤í”¼ì˜ í´ë¡œë¡œê²ì‚°ì€ ì‚°í™” ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ì¤„ì´ê³ , ì¹´í˜ì¸ì€ ì•„ë°ë…¸ì‹  ìˆ˜ìš©ì²´ë¥¼ ì°¨ë‹¨í•˜ì—¬ ì‹ ì¥ì˜ ì‚°ì†Œ ì†Œë¹„ë¥¼ ì¡°ì ˆí•©ë‹ˆë‹¤. ë°˜ë©´ ê³¼ë‹¹(Fructose)ì€ ìš”ì‚°ì„ ì¦ê°€ì‹œì¼œ í•´ë¡­ìŠµë‹ˆë‹¤.`,
            'diabetes': `<strong>[ë‹¹ë‡¨ í™˜ì]</strong> Tang et al. (2024) ì—°êµ¬ì— ë”°ë¥´ë©´, ë‹¹ë‡¨ í™˜ìëŠ” ê¸°ìƒ í›„ 1ì‹œê°„ ì´ë‚´ì— ì»¤í”¼ë¥¼ ì„­ì·¨í–ˆì„ ë•Œ ì‹ ì¥ ë³´í˜¸ íš¨ê³¼ê°€ ê°€ì¥ ì»¸ìŠµë‹ˆë‹¤. ë‹¨, ë¯¹ìŠ¤ì»¤í”¼ëŠ” í˜ˆë‹¹ ê´€ë¦¬ì— ì¹˜ëª…ì ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
            'gender': `<strong>[ì„±ë³„ ì°¨ì´]</strong> ì—¬ì„±ì€ ì—ìŠ¤íŠ¸ë¡œê²ì´ ì¹´í˜ì¸ ëŒ€ì‚¬ë¥¼ ì§€ì—°ì‹œì¼œ ì²´ë‚´ ë†ë„ë¥¼ ìœ ì§€í•˜ê³ , ì‹ ì¥ ì¡°ì§ì˜ ì‚°í™” ì†ìƒì„ ë°©ì–´í•˜ëŠ” í˜¸ë¥´ëª¬ íš¨ê³¼ë¡œ ì¸í•´ ë‚¨ì„±ë³´ë‹¤ ëšœë ·í•œ ì´ì ì„ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
            'conclusion': `<strong>[ì ì • ê²°ë¡ ]</strong> 'ì ì ˆí•œ ë¸”ë™ì»¤í”¼(í•˜ë£¨ 2-3ì”)'ì™€ 'ì˜¤ì „ì˜ ì°¨ í•œ ì”'ì€ ì‹ ì¥ ê±´ê°•ì— ìœ ìµí•  ìˆ˜ ìˆìœ¼ë‚˜, ê°€ë‹¹ìŒë£Œì™€ ë¯¹ìŠ¤ì»¤í”¼ëŠ” ëª…ë°±í•œ ìœ„í—˜ ì¸ìì…ë‹ˆë‹¤.`
        };

        async function callGemini(query) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: query }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                
                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    return marked.parse(data.candidates[0].content.parts[0].text);
                } else {
                    return null; // Trigger fallback
                }
            } catch (e) {
                console.error(e);
                return null; // Trigger fallback
            }
        }

        async function askAI(key) {
            const userTexts = {
                'method': "ì—°êµ¬ ë°ì´í„°ì™€ ë°©ë²•ë¡ ì€?", 'coffee_diff': "ë¯¹ìŠ¤ì»¤í”¼ì™€ ë¸”ë™ì»¤í”¼ì˜ ì°¨ì´ëŠ”?", 'tea_timing': "ì°¨ëŠ” ì–¸ì œ ë§ˆì‹œëŠ” ê²Œ ì¢‹ì•„?",
                'mechanism': "ì–´ë–¤ ì›ë¦¬ë¡œ ì‹ ì¥ì— ì¢‹ì•„?", 'diabetes': "ë‹¹ë‡¨ í™˜ìì—ê²ŒëŠ” ì–´ë•Œ?", 'gender': "ë‚¨ë…€ ì°¨ì´ê°€ ìˆì–´?",
                'conclusion': "ê·¸ë˜ì„œ ê²°ë¡ ì´ ë­ì•¼?"
            };
            
            const query = userTexts[key] || key;
            addBubble(query, "user");
            const loadingId = showLoading();
            
            // Try API first, then Fallback
            let reply = await callGemini(query);
            if (!reply && knowledgeBase[key]) {
                reply = knowledgeBase[key]; // Use local fallback
            } else if (!reply) {
                reply = "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ AI ì—°ê²°ì´ ì›í™œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
            }
            
            removeLoading(loadingId);
            addBubble(reply, "ai");
        }

        async function sendUserQuery() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if(!text) return;
            
            addBubble(text, "user");
            input.value = "";
            const loadingId = showLoading();
            
            let reply = await callGemini(text);
            if (!reply) {
                // Simple keyword matching fallback
                if(text.includes("ë‹¹ë‡¨")) reply = knowledgeBase['diabetes'];
                else if(text.includes("ë¯¹ìŠ¤") || text.includes("ë¸”ë™")) reply = knowledgeBase['coffee_diff'];
                else if(text.includes("ì°¨") || text.includes("ë…¹ì°¨")) reply = knowledgeBase['tea_timing'];
                else reply = "ì£„ì†¡í•©ë‹ˆë‹¤. AI ì—°ê²° ë¬¸ì œë¡œ ë‹µë³€ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            }
            
            removeLoading(loadingId);
            addBubble(reply, "ai");
        }

        function addBubble(text, type) {
            const chatWindow = document.getElementById('chat-window');
            const isUser = type === 'user';
            const align = isUser ? 'justify-end' : '';
            const bg = isUser ? 'bg-indigo-500 text-white shadow-md' : 'glass-panel text-xs opacity-90 border border-slate-500/10 shadow-sm';
            const radius = isUser ? 'rounded-tr-none' : 'rounded-tl-none';
            const icon = isUser ? '' : '<div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500/10 flex items-center justify-center text-sm border border-indigo-500/20">ğŸ‘©â€ğŸ’»</div>';
            
            const html = `
                <div class="flex gap-3 chat-bubble ${align}">
                    ${icon}
                    <div class="${bg} p-3.5 rounded-2xl ${radius} max-w-[88%] ${isUser ? 'text-xs font-medium' : ''} prose prose-invert prose-p:my-1 prose-headings:my-2">
                        ${text}
                    </div>
                </div>`;
            chatWindow.insertAdjacentHTML('beforeend', html);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function showLoading() {
            const chatWindow = document.getElementById('chat-window');
            const id = 'typing-' + Date.now();
            chatWindow.insertAdjacentHTML('beforeend', `
                <div id="${id}" class="flex gap-3 chat-bubble mt-2">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-500/10 flex items-center justify-center text-sm border border-indigo-500/20">ğŸ‘©â€ğŸ’»</div>
                    <div class="glass-panel p-3 rounded-2xl rounded-tl-none border border-slate-500/10">
                        <div class="flex gap-1">
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span>
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></span>
                            <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        </div>
                    </div>
                </div>`);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        // --- Simulator Logic ---
        const counts = { black: 0, tea: 0, mix: 0, ssb: 0 };
        const states = [
            { limit: 30, title: "ìœ„í—˜ (High Risk)", icon: "ğŸ¤®", desc: "ë‹¹ë¶„ ê³¼ë‹¤! ê°€ë‹¹ìŒë£Œì™€ ë¯¹ìŠ¤ì»¤í”¼ë¥¼ ì¤„ì´ì„¸ìš”." },
            { limit: 60, title: "ì£¼ì˜ (Caution)", icon: "ğŸ˜µâ€ğŸ’«", desc: "ë¯¹ìŠ¤ì»¤í”¼ ì„­ì·¨ë¥¼ ë¸”ë™ì»¤í”¼ë¡œ ë°”ê¿”ë³´ì„¸ìš”." },
            { limit: 85, title: "ì–‘í˜¸ (Good)", icon: "ğŸ™‚", desc: "ì¢‹ìŠµë‹ˆë‹¤. ìˆ˜ë¶„ ì„­ì·¨ë¥¼ ìœ ì§€í•˜ì„¸ìš”." },
            { limit: 101, title: "ìµœì  (Optimal)", icon: "ğŸ«˜", desc: "ì‹ ì¥ ê±´ê°•ì— ê°€ì¥ ì´ìƒì ì¸ íŒ¨í„´ì…ë‹ˆë‹¤!" }
        ];

        window.addDrink = (t) => { 
            counts[t]++;
            updateUI(t);
            showFloatingScore(t === 'tea' ? '+3' : t === 'black' ? '+2' : t === 'mix' ? '-5' : '-10', t);
            animateChar(t); 
        };

        window.removeDrink = (t, e) => {
            if(e) e.stopPropagation();
            if(counts[t] > 0) {
                counts[t]--;
                updateUI(t);
                animateChar('remove');
            }
        };
        
        window.resetDrinks = () => { for(let k in counts) counts[k]=0; updateUI(); };
        window.pokeKidney = () => { animateChar('poke'); };

        function showFloatingScore(text, type) {
            const container = document.getElementById('score-float-container');
            const el = document.createElement('div');
            el.className = 'floating-score';
            el.innerText = text;
            
            if(type==='tea') el.style.color='#10B981';
            else if(type==='black') el.style.color='#6366F1';
            else if(type==='mix') el.style.color='#F59E0B';
            else el.style.color='#F43F5E';
            
            container.appendChild(el);
            setTimeout(() => el.remove(), 800);
        }

        function animateChar(type) {
            const char = document.getElementById('kidney-char');
            char.style.animation = 'none';
            void char.offsetWidth; // Trigger reflow
            char.style.animation = null; 
            
            char.classList.remove('animate__headShake', 'animate__rubberBand', 'animate__wobble');
            
            if(type === 'mix' || type === 'ssb') char.classList.add('animate__headShake');
            else if(type === 'remove') char.classList.add('animate__wobble');
            else char.classList.add('animate__rubberBand');
        }

        function updateUI(t) {
            if(t) document.getElementById(`count-${t}`).innerText = counts[t] + "ì”";
            else document.querySelectorAll('[id^="count-"]').forEach(e=>e.innerText='0ì”');
            
            let score = 100 + (counts.black*2) + (counts.tea*3) - (counts.mix*5) - (counts.ssb*10);
            if(document.getElementById('check-diabetes').checked) score -= (counts.mix*2 + counts.ssb*5);
            score = Math.max(0, Math.min(100, score));
            
            // Find state based on updated score
            const s = states.find(s => score < s.limit) || states[3];
            
            document.getElementById('score-val').innerText = score + "ì ";
            document.getElementById('status-badge').innerText = s.title;
            document.getElementById('status-desc').innerText = s.desc;
            document.getElementById('kidney-char').innerText = s.icon; // **Crucial Fix: Update Emoji**
            
            const bar = document.getElementById('health-bar');
            bar.style.width = `${score}%`;
            
            let colorClass = 'from-emerald-500 to-teal-400';
            if(score < 30) colorClass = 'from-rose-600 to-red-500';
            else if(score < 60) colorClass = 'from-amber-500 to-orange-400';
            else if(score < 85) colorClass = 'from-blue-500 to-indigo-400';
            
            bar.className = `h-full w-full transition-all duration-500 relative bg-gradient-to-r ${colorClass}`;
        }
        
        window.updateKidneyStatus = () => updateUI();

        // --- Charts & Particles ---
        let doseChart;
        function initCharts() { initDoseChart(); initBubbleChart(); }

        function initBubbleChart() {
            const papers = [
                { author: "Mazidi", year: 2022, n: 12385, type: "Cross", text: "NHANES (MR)" },
                { author: "Gao", year: 2025, n: 49827, type: "Cross", text: "NHANES" },
                { author: "Guo", year: 2025, n: 99744, type: "Cohort", text: "JACC (Japan)" },
                { author: "Hu", year: 2018, n: 14209, type: "Cohort", text: "ARIC (USA)" },
                { author: "Tang", year: 2022, n: 359906, type: "Cohort", text: "UK Biobank" },
                { author: "Kanbay", year: 2021, n: 505841, type: "Meta", text: "Meta-analysis" },
                { author: "van Westing", year: 2023, n: 5447, type: "Cohort", text: "Rotterdam" },
                { author: "Tang (Dia)", year: 2024, n: 8564, type: "Cross", text: "NHANES (Diabetic)" },
                { author: "Jhee", year: 2018, n: 8717, type: "Cohort", text: "KoGES (Korea)" },
                { author: "Kim", year: 2013, n: 2673, type: "Cross", text: "KNHANES IV (Women)" },
                { author: "Shin", year: 2018, n: 2110, type: "Cross", text: "KNHANES 2014" },
                { author: "Park", year: 2018, n: 3500, type: "Cross", text: "KNHANES 13-14" }
            ];
            const trace = {
                x: papers.map(p => p.year), y: papers.map(p => p.n), text: papers.map(p => p.author),
                mode: 'markers', marker: { size: papers.map(p => Math.sqrt(p.n)/4), sizemode: 'area', color: isDarkMode ? '#6366f1' : '#db2777', opacity: 0.7 }
            };
            const layout = {
                margin: {t:10, l:40, r:10, b:40}, paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                xaxis: { title: 'Publication Year', color: isDarkMode ? '#94a3b8' : '#64748b' },
                yaxis: { title: 'Participants (Log)', type: 'log', color: isDarkMode ? '#94a3b8' : '#64748b' },
                hovermode: 'closest'
            };
            Plotly.newPlot('bubbleChart', [trace], layout, {displayModeBar: false, responsive: true});
            document.getElementById('bubbleChart').on('plotly_click', function(data){
                const idx = data.points[0].pointIndex; const p = papers[idx];
                const panel = document.getElementById('study-detail-panel'); panel.classList.remove('hidden');
                document.getElementById('detail-title').innerText = `${p.author} et al. (${p.year})`;
                document.getElementById('detail-desc').innerText = `N=${p.n.toLocaleString()} (${p.type}). Source: ${p.text}`;
            });
        }

        function initDoseChart() {
            const ctx = document.getElementById('doseChart').getContext('2d');
            doseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0ì”', '1ì”', '2ì”', '3ì”', '4ì”', '5ì”+'],
                    datasets: [{
                        label: 'CKD ìœ„í—˜ë„ (1.0=ê¸°ì¤€)', data: [1.0, 0.92, 0.85, 0.78, 0.76, 0.82],
                        borderColor: isDarkMode ? '#fbbf24' : '#db2777', backgroundColor: isDarkMode ? 'rgba(251, 191, 36, 0.1)' : 'rgba(219, 39, 119, 0.1)',
                        tension: 0.4, fill: true, pointRadius: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { min: 0.6, max: 1.1, grid: { display: false }, ticks: { color: 'rgba(150,150,150,0.5)' } }, x: { grid: { display: false }, ticks: { color: 'rgba(150,150,150,0.5)' } } } }
            });
        }

        function updateChartColors(isDark) {
            if(doseChart) {
                doseChart.data.datasets[0].borderColor = isDark ? '#fbbf24' : '#db2777';
                doseChart.data.datasets[0].backgroundColor = isDark ? 'rgba(251, 191, 36, 0.1)' : 'rgba(219, 39, 119, 0.1)';
                doseChart.update();
            }
        }

        document.getElementById('cup-slider').addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            document.getElementById('cup-display').innerText = val === 6 ? "6+" : val;
            const insights = ["ê¸°ì¤€ì ì…ë‹ˆë‹¤.", "ì•½ê°„ì˜ ì´ì  (íƒ€ì´ë° ì¤‘ìš”)", "ìœ ì˜ë¯¸í•œ í•­ì‚°í™” íš¨ê³¼", "ìµœì ì˜ ë²”ìœ„ (Sweet Spot)", "ë†’ì€ ë³´í˜¸ íš¨ê³¼", "íš¨ê³¼ í‰íƒ„í™”/ë¶€ì‘ìš© ì£¼ì˜", "ê³¼ë‹¤ ì„­ì·¨ ì£¼ì˜"];
            document.getElementById('insight-box').innerText = insights[Math.min(val, 6)];
            const colors = new Array(6).fill(isDarkMode ? 'white' : 'white');
            colors[Math.min(val, 5)] = isDarkMode ? '#fbbf24' : '#db2777';
            doseChart.data.datasets[0].pointBackgroundColor = colors;
            doseChart.data.datasets[0].pointRadius = colors.map(c => c === 'white' ? 4 : 8);
            doseChart.update();
        });

        // --- Particles ---
        const particleCtx = particleCanvas.getContext('2d');
        let width, height, particles = [], animationFrameId;
        window.addEventListener('resize', () => { width = particleCanvas.width = window.innerWidth; height = particleCanvas.height = window.innerHeight; });
        
        class Particle {
            constructor(type) { this.type = type; this.init(); }
            init() {
                this.x = Math.random() * width; this.y = Math.random() * height;
                this.size = Math.random() * (this.type === 'sakura' ? 6 : 2);
                this.speedX = (Math.random() - 0.5) * (this.type === 'sakura' ? 1.5 : 0.2);
                this.speedY = Math.random() * (this.type === 'sakura' ? 2 : 0.2) + 0.1;
                this.opacity = Math.random() * 0.5 + 0.2;
                this.rotation = Math.random() * 360;
                this.rotationSpeed = (Math.random() - 0.5) * 2;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                if(this.type === 'sakura') { this.rotation += this.rotationSpeed; this.x += Math.sin(this.y * 0.01) * 0.5; }
                if (this.y > height) this.y = -10; if (this.x > width) this.x = 0; if (this.x < 0) this.x = width;
            }
            draw() {
                particleCtx.save(); particleCtx.globalAlpha = this.opacity;
                if(this.type === 'sakura') {
                    particleCtx.translate(this.x, this.y); particleCtx.rotate(this.rotation * Math.PI / 180);
                    particleCtx.fillStyle = '#FDA4AF'; 
                    particleCtx.beginPath(); 
                    particleCtx.moveTo(0,0); particleCtx.bezierCurveTo(this.size/2, -this.size/2, this.size, 0, 0, this.size); 
                    particleCtx.bezierCurveTo(-this.size, 0, -this.size/2, -this.size/2, 0, 0); 
                    particleCtx.fill();
                } else {
                    particleCtx.fillStyle = '#FFFFFF'; particleCtx.beginPath(); particleCtx.arc(this.x, this.y, this.size, 0, Math.PI * 2); particleCtx.fill();
                }
                particleCtx.restore();
            }
        }

        function initParticles(type) {
            if(animationFrameId) cancelAnimationFrame(animationFrameId);
            width = particleCanvas.width = window.innerWidth; height = particleCanvas.height = window.innerHeight;
            particles = [];
            const count = type === 'sakura' ? 50 : 80;
            for(let i=0; i<count; i++) particles.push(new Particle(type));
            animate();
        }

        function animate() {
            particleCtx.clearRect(0, 0, width, height);
            particles.forEach(p => { p.update(); p.draw(); });
            animationFrameId = requestAnimationFrame(animate);
        }

        // Init
        initCharts();
        initParticles('sakura'); 
        updateUI(); // Initial UI update
    </script>
</body>
</html>
